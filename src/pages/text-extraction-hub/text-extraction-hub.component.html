<div class="max-w-4xl mx-auto">
  <div class="text-center mb-10">
    <h1 class="text-3xl font-bold text-gray-900">هاب استخراج متن</h1>
    <p class="mt-2 text-gray-600">استخراج هوشمند اطلاعات از انواع فایل‌ها.</p>
  </div>

  <canvas id="pdf-canvas" class="hidden"></canvas>

  @if(apiKeyError()) {
    <div class="bg-red-100 border-r-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert">
      <p class="font-bold">خطای پیکربندی</p>
      <p>کلید API برای ارتباط با سرویس هوش مصنوعی تنظیم نشده است.</p>
    </div>
  } @else {
    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200">
      <div class="border-b border-gray-200 mb-6">
        <nav class="-mb-px flex space-x-6 space-x-reverse" aria-label="Tabs">
          @for(modeKey of getModeKeys(); track modeKey) {
            <button (click)="setMode(modeKey)" 
                    [class.border-cyan-500]="mode() === modeKey" 
                    [class.text-cyan-600]="mode() === modeKey" 
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors duration-200">
              {{ modeConfigs[modeKey].title }}
            </button>
          }
        </nav>
      </div>

      <div>
        @if (imagePreviewUrl()) {
          <div class="mb-4 text-center">
            <h3 class="text-lg font-medium text-gray-800 mb-2">پیش‌نمایش فایل (صفحه اول)</h3>
            <img [src]="imagePreviewUrl()" alt="Image preview" class="max-h-80 mx-auto rounded-lg shadow-md border border-gray-200">
             <p class="text-sm text-gray-500 mt-2">فایل انتخاب شده: {{ selectedFileName() }}</p>
          </div>
        }
        <div (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)"
             class="mt-4 flex justify-center rounded-lg border border-dashed px-6 py-10 transition-colors duration-200"
             [class.border-cyan-500]="isDragging()"
             [class.bg-cyan-50]="isDragging()"
             [class.border-gray-900/25]="!isDragging()">
          <div class="text-center">
            <svg class="mx-auto h-12 w-12 text-gray-300" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" [attr.d]="currentModeConfig().icon" clip-rule="evenodd" />
            </svg>
            <div class="mt-4 flex text-sm leading-6 text-gray-600">
              <label for="file-upload" class="relative cursor-pointer rounded-md bg-white font-semibold text-cyan-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-cyan-600 focus-within:ring-offset-2 hover:text-cyan-500">
                <span>
                  @switch(mode()) {
                    @case ('handwriting') { <span>یک تصویر از دست‌نوشته خود را انتخاب کنید</span> }
                    @case ('pdf') { <span>فایل PDF خود را انتخاب کنید</span> }
                    @case ('audio') { <span>فایل صوتی خود را انتخاب کنید</span> }
                    @case ('video') { <span>فایل ویدئویی خود را انتخاب کنید</span> }
                  }
                </span>
                <input id="file-upload" name="file-upload" type="file" class="sr-only" 
                       [accept]="currentModeConfig().accept"
                       (change)="onFileSelected($event)">
              </label>
              <p class="pr-1">یا آن را اینجا بکشید و رها کنید</p>
            </div>
            @if (selectedFileName() && !imagePreviewUrl()) {
              <p class="text-sm text-gray-500 mt-2">فایل انتخاب شده: {{ selectedFileName() }}</p>
            }
          </div>
        </div>
      </div>
      
      <div class="mt-6">
        @if (!isProcessingSupported() && selectedFile()) {
          <div class="bg-yellow-100 border-r-4 border-yellow-500 text-yellow-800 p-4 rounded-lg" role="alert">
            <p class="font-bold">قابلیت در دست توسعه</p>
            <p>{{ currentModeConfig().unsupportedMessage }}</p>
          </div>
        }
        <button (click)="extractText()" [disabled]="loading() || !selectedFile() || !isProcessingSupported() || imageBases64().length === 0"
              class="w-full flex justify-center items-center gap-2 bg-cyan-600 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-cyan-700 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed">
          @if(loading()) {
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>{{ loadingMessage() || 'در حال پردازش...' }}</span>
          } @else {
            <span>استخراج متن</span>
          }
        </button>
      </div>
    </div>

    @if(error()) {
      <div class="mt-8 bg-red-100 border border-red-200 text-red-800 p-4 rounded-lg">
        <p><strong>خطا:</strong> {{ error() }}</p>
      </div>
    }

    @if(result()) {
      <div class="mt-8 bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 border-b pb-2">متن استخراج شده</h2>
        <div class="prose prose-lg max-w-none text-right whitespace-pre-wrap" [innerHTML]="result() | safeHtml"></div>
      </div>
    }
  }
</div>
